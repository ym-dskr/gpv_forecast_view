<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPVäºˆå ± - å®˜ç½²åœ°å›³ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        h1 {
            font-size: 2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #999;
            font-size: 0.9em;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            height: calc(100vh - 80px);
            background-color: #2d2d2d;
            /* åœ°å›³ãƒ­ãƒ¼ãƒ‰å‰ã®èƒŒæ™¯è‰² */
        }

        .sidebar {
            width: 450px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-left: 2px solid rgba(102, 126, 234, 0.3);
            overflow-y: auto;
            padding: 20px;
        }

        .station-info {
            margin-bottom: 20px;
        }

        .station-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .station-coords {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        canvas {
            max-height: 200px;
        }

        .no-selection {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .no-selection-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 26, 26, 0.95);
            color: #e0e0e0;
            border-radius: 10px;
        }

        .leaflet-popup-content {
            margin: 10px;
        }

        .leaflet-popup-tip {
            background: rgba(26, 26, 26, 0.95);
        }

        .popup-station-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .popup-coords {
            font-size: 0.9em;
            color: #999;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            #map {
                height: 50vh;
            }

            .sidebar {
                width: 100%;
                height: 50vh;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ—¾ GPVäºˆå ± å®˜ç½²åœ°å›³ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h1>
        <p class="subtitle">åœ°å›³ä¸Šã®å®˜ç½²ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ™‚ç³»åˆ—äºˆå ±ã‚’è¡¨ç¤º</p>
    </header>

    <div class="container">
        <div id="map"></div>

        <div class="sidebar" id="sidebar">
            <div class="no-selection">
                <div class="no-selection-icon">ğŸ“</div>
                <p>åœ°å›³ä¸Šã®å®˜ç½²ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>æ™‚ç³»åˆ—äºˆå ±ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // å®˜ç½²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        const stationData = {{ STATION_DATA }};

        // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        console.log('Station data loaded:', Object.keys(stationData).length, 'stations');

        // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        if (!stationData || Object.keys(stationData).length === 0) {
            document.getElementById('sidebar').innerHTML = `
                <div class="no-selection">
                    <div class="no-selection-icon">âš ï¸</div>
                    <p>ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>station_timeseries.pyã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
        }

        // åœ°å›³ã‚’åˆæœŸåŒ–ï¼ˆæ—¥æœ¬ä¸­å¿ƒï¼‰
        const map = L.map('map').setView([36.5, 138], 6);

        // OpenStreetMap ã‚¿ã‚¤ãƒ«ï¼ˆæ¨™æº–ï¼‰
        // CartoDBã®Dark MatterãŒè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æ¨™æº–OSMã‚’ä½¿ç”¨
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³
        const stationIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">ğŸ“</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è‰²è¨­å®š
        const paramColors = {
            'æ°—æ¸©': '#ff6b6b',
            'æ°—åœ§': '#4ecdc4',
            'æ¹¿åº¦': '#45b7d1',
            'é¢¨é€Ÿ': '#96ceb4',
            'é™æ°´é‡': '#5f9ea0',
            'é›²é‡': '#95a5a6'
        };

        // å„å®˜ç½²ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®
        const markers = [];
        Object.entries(stationData).forEach(([stationName, stationInfo]) => {
            const { coords, data } = stationInfo;

            if (!coords || !coords.lat || !coords.lon) {
                console.error('Invalid coords for station:', stationName);
                return;
            }

            const marker = L.marker([coords.lat, coords.lon], { icon: stationIcon })
                .addTo(map)
                .bindPopup(`
                    <div class="popup-station-name">${stationName}</div>
                    <div class="popup-coords">
                        ç·¯åº¦: ${coords.lat.toFixed(2)}Â°N<br>
                        çµŒåº¦: ${coords.lon.toFixed(2)}Â°E
                    </div>
                `);

            marker.on('click', () => {
                showStationData(stationName, stationInfo);
            });

            markers.push(marker);
        });

        // å…¨ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ãŒåã¾ã‚‹ã‚ˆã†ã«åœ°å›³ã®è¡¨ç¤ºç¯„å›²ã‚’èª¿æ•´
        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã”ã¨ã®æœ€å°å€¤ãƒ»æœ€å¤§å€¤ã‚’è¨ˆç®—ï¼ˆYè»¸çµ±ä¸€ç”¨ï¼‰
        const paramRanges = {};
        const paramNames = Object.keys(paramColors);

        paramNames.forEach(paramName => {
            let allValues = [];
            Object.values(stationData).forEach(station => {
                if (station.data && station.data[paramName]) {
                    allValues = allValues.concat(station.data[paramName].values);
                }
            });

            // NaNã‚’é™¤å¤–
            allValues = allValues.filter(v => !isNaN(v));

            if (allValues.length > 0) {
                const minVal = Math.min(...allValues);
                const maxVal = Math.max(...allValues);

                // é›²é‡ã¨æ¹¿åº¦ã¯0-100%ã«å›ºå®š
                if (['é›²é‡', 'æ¹¿åº¦'].includes(paramName)) {
                    paramRanges[paramName] = { min: 0, max: 100 };
                } else {
                    // ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼ˆä¸Šä¸‹10%ï¼‰
                    let margin = (maxVal - minVal) * 0.1;
                    if (margin === 0) margin = maxVal === 0 ? 1.0 : Math.abs(maxVal) * 0.1;

                    paramRanges[paramName] = {
                        min: minVal - margin,
                        max: maxVal + margin
                    };
                }
            }
        });

        // å®˜ç½²ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        function showStationData(stationName, stationInfo) {
            const sidebar = document.getElementById('sidebar');
            const { coords, data } = stationInfo;

            let html = `
                <div class="station-info">
                    <div class="station-name">${stationName}</div>
                    <div class="station-coords">
                        ğŸ“ ç·¯åº¦: ${coords.lat.toFixed(2)}Â°N, çµŒåº¦: ${coords.lon.toFixed(2)}Â°E
                    </div>
                </div>
            `;

            // å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
            Object.entries(data).forEach(([paramName, paramData]) => {
                const chartId = `chart-${stationName}-${paramName}`.replace(/\s+/g, '-');
                html += `
                    <div class="chart-container">
                        <div class="chart-title">${paramName}</div>
                        <canvas id="${chartId}"></canvas>
                    </div>
                `;
            });

            sidebar.innerHTML = html;

            // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»
            Object.entries(data).forEach(([paramName, paramData]) => {
                const chartId = `chart-${stationName}-${paramName}`.replace(/\s+/g, '-');
                const ctx = document.getElementById(chartId);

                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: paramData.times.map(t => {
                                const date = new Date(t);
                                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:00`;
                            }),
                            datasets: [{
                                label: paramName,
                                data: paramData.values,
                                borderColor: paramColors[paramName] || '#667eea',
                                backgroundColor: (paramColors[paramName] || '#667eea') + '20',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: '#e0e0e0',
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                y: {
                                    min: paramRanges[paramName] ? paramRanges[paramName].min : undefined,
                                    max: paramRanges[paramName] ? paramRanges[paramName].max : undefined,
                                    ticks: {
                                        color: '#e0e0e0'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }
    </script>
</body>

</html>